#!/bin/bash
set -euo pipefail

# sm — SpaceMolt CLI for AI agents
# Uses REST API directly. Zero LLM tokens per call.
#
# Usage:
#   sm login                  Login and save session (reads ./me/credentials.txt)
#   sm status                 Credits, location, ship, fuel, cargo summary
#   sm pois                   List POIs in current system with type/distance
#   sm system                 Current system overview (connections + POIs)
#   sm log                    Show recent captain's log entries
#   sm log add "entry text"   Add a captain's log entry
#   sm cargo                  Show cargo contents
#   sm sell-all               Sell all cargo at current base
#   sm skills                 Show trained skills
#   sm nearby                 Show nearby players
#   sm notifications          Check pending notifications
#   sm travel <poi-id>        Travel to a POI
#   sm chat <channel> "msg"   Send chat (system/local/faction/private)
#   sm raw <endpoint> [json]  Raw API call, returns full JSON

API="https://game.spacemolt.com/api/v1"
SESSION_FILE="/tmp/sm-session"
CRED_FILE="${SM_CRED_FILE:-/work/me/credentials.txt}"

# --- Helpers ---

die() { echo "ERROR: $*" >&2; exit 1; }

get_session() {
  [ -f "$SESSION_FILE" ] || die "Not logged in. Run: sm login"
  cat "$SESSION_FILE"
}

api() {
  local endpoint="$1"
  local body="${2:-"{}"}"
  local sid
  sid=$(get_session)
  # Inject session_id into body
  body=$(echo "$body" | jq --arg s "$sid" '. + {session_id: $s}')
  local http_code resp
  resp=$(curl -s -w '\n%{http_code}' -X POST "${API}/${endpoint}" \
    -H "Content-Type: application/json" \
    -H "X-Session-Id: ${sid}" \
    -d "$body")
  http_code=$(echo "$resp" | tail -1)
  resp=$(echo "$resp" | sed '$d')
  if [ "$http_code" -ge 400 ] 2>/dev/null; then
    echo "HTTP $http_code: $resp" >&2
    echo "$resp"
    return 1
  fi
  echo "$resp"
}

api_no_session() {
  local endpoint="$1"
  local body="${2:-"{}"}"
  local http_code resp
  resp=$(curl -s -w '\n%{http_code}' -X POST "${API}/${endpoint}" \
    -H "Content-Type: application/json" \
    -d "$body")
  http_code=$(echo "$resp" | tail -1)
  resp=$(echo "$resp" | sed '$d')
  if [ "$http_code" -ge 400 ] 2>/dev/null; then
    echo "HTTP $http_code: $resp" >&2
    echo "$resp"
    return 1
  fi
  echo "$resp"
}

# --- Commands ---

cmd_login() {
  [ -f "$CRED_FILE" ] || die "No credentials at $CRED_FILE"
  local user pass
  user=$(grep '^Username:' "$CRED_FILE" | sed 's/^Username: *//')
  pass=$(grep '^Password:' "$CRED_FILE" | sed 's/^Password: *//')
  [ -n "$user" ] && [ -n "$pass" ] || die "Can't parse credentials"

  # Create session
  local sresp sid
  sresp=$(api_no_session "session" '{}')
  sid=$(echo "$sresp" | jq -r '.session.id // .session_id // empty')
  [ -n "$sid" ] || die "Failed to create session: $sresp"

  # Login
  local lresp
  lresp=$(curl -sf -X POST "${API}/login" \
    -H "Content-Type: application/json" \
    -H "X-Session-Id: ${sid}" \
    -d "$(jq -n --arg u "$user" --arg p "$pass" --arg s "$sid" \
      '{username: $u, password: $p, session_id: $s}')")

  local err
  err=$(echo "$lresp" | jq -r '.error // empty')
  [ -z "$err" ] || die "Login failed: $err"

  echo "$sid" > "$SESSION_FILE"
  echo "Logged in as $user (session: ${sid:0:12}...)"
}

cmd_status() {
  api "get_status" | jq -r '
    .result as $r | $r.player as $p | $r.ship as $s |
    def safe(f): f // "?";
    "Credits: \(safe($p.credits))",
    "Location: \(safe($p.current_system))\(if $p.current_poi then " / \($p.current_poi)" else "" end)\(if $p.docked_at_base then " (docked)" else "" end)",
    "Ship: \(safe($s.class_id // $s.name))",
    "Hull: \(safe($s.hull))/\(safe($s.max_hull)) | Fuel: \(safe($s.fuel))/\(safe($s.max_fuel))",
    "Cargo: \(safe($s.cargo_used))/\(safe($s.cargo_capacity))"
  '
}

cmd_pois() {
  api "get_system" | jq -r '
    .result.pois // [] | sort_by(.distance // 0) |
    map(
      (.name // .type // "unnamed") + " [" + (.type // "?") + "]" +
      (if .distance then " (" + (.distance | tostring) + " AU)" else "" end) +
      (if .base then " *base*" else "" end) +
      "\n  id: " + (.id // "?")
    ) | join("\n")
  '
}

cmd_system() {
  api "get_system" | jq -r '
    .result as $r |
    "System: \($r.name // $r.system_name // "?")",
    "Security: \(($r.police_level // "?") | tostring)",
    "",
    "POIs (\($r.pois // [] | length)):",
    (($r.pois // []) | map("  " + (.name // .type // "?") + " [" + (.type // "?") + "] id:" + (.id // "?")) | join("\n")),
    "",
    "Connections (\($r.connections // [] | length)):",
    (($r.connections // []) | map("  → " + (.name // .system_name // .id // "?") + " (id:" + (.id // .system_id // "?") + ")") | join("\n"))
  '
}

cmd_log() {
  if [ "${1:-}" = "add" ]; then
    shift
    local entry="${1:?Usage: sm log add \"entry text\"}"
    api "captains_log_add" "$(jq -n --arg e "$entry" '{entry: $e}')" | jq -r '
      if .error then "ERROR: \(.error)" else "Log entry added." end
    '
  else
    api "captains_log_list" | jq -r '
      .result.entries // [] | .[0:5] | to_entries |
      map("#\(.key): \(.value.entry // (.value | tostring))") |
      join("\n---\n")
    '
  fi
}

cmd_cargo() {
  api "get_cargo" | jq -r '
    .result as $r |
    ($r.cargo // []) as $items |
    "\($r.used // 0)/\($r.capacity // "?") used" + "\n" +
    if ($items | length) == 0 then "No cargo items."
    else ($items | map("  \(.item_id // .name // .id) x\(.quantity // 1)") | join("\n"))
    end
  '
}

cmd_sell_all() {
  local cargo_resp items
  cargo_resp=$(api "get_cargo")

  # Extract items as "id quantity" pairs
  items=$(echo "$cargo_resp" | jq -r '
    .result.cargo // [] |
    map({id: (.item_id // .name // .id), qty: (.quantity // 1)}) |
    map(select(.qty > 0)) | .[] | "\(.id) \(.qty)"
  ' 2>/dev/null)

  if [ -z "$items" ]; then
    echo "Nothing to sell (cargo empty or unreadable)."
    return 0
  fi

  local total=0
  while IFS=' ' read -r item_id qty; do
    [ -n "$item_id" ] || continue
    local result
    result=$(api "sell" "$(jq -n --arg i "$item_id" --argjson q "$qty" '{item_id: $i, quantity: $q}')" 2>/dev/null)
    local err
    err=$(echo "$result" | jq -r '.error // empty' 2>/dev/null)
    if [ -n "$err" ]; then
      echo "  $item_id x$qty: FAILED ($err)"
    else
      local earned
      earned=$(echo "$result" | jq -r '.result.credits_earned // .result.earned // "?" ' 2>/dev/null)
      echo "  $item_id x$qty: sold (+${earned} cr)"
      if [ "$earned" != "?" ] 2>/dev/null; then
        total=$((total + earned))
      fi
    fi
    sleep 11  # respect tick rate limit
  done <<< "$items"
  echo "Done. Total earned: ${total} cr"
}

cmd_skills() {
  api "get_skills" | jq -r '
    .result.player_skills // []
    | sort_by(-.level, -.current_xp)
    | map("\(.name): L\(.level) (\(.current_xp // 0)/\(.next_level_xp // "?") XP)")
    | if length == 0 then ["(no skills trained yet)"] else . end
    | join("\n")
  '
}

cmd_nearby() {
  api "get_nearby" | jq -r '
    .result.nearby // .result.players // [] |
    if length == 0 then "No one nearby."
    else map(
      (.username // .name // "anonymous") +
      (if .ship_class then " [" + .ship_class + "]" else "" end) +
      (if .clan_tag and .clan_tag != "" then " <" + .clan_tag + ">" else "" end)
    ) | join("\n")
    end
  '
}

cmd_notifications() {
  # Notifications piggyback on every API response; use get_status as the carrier
  api "get_status" | jq -r '
    .notifications // [] |
    if length == 0 then "No notifications."
    else map(
      "[" + (.type // "?") + "] " + (.message // .content // tostring)
    ) | join("\n")
    end
  '
}

cmd_travel() {
  local poi="${1:?Usage: sm travel <poi-id>}"
  api "travel" "$(jq -n --arg p "$poi" '{target_poi: $p}')" | jq -r '
    if .error then "ERROR: \(.error)"
    else .result | "Traveling to \(.poi_name // .destination // "destination")... ETA: \(.eta // .travel_time // "?") ticks"
    end
  '
}

cmd_dock()   { api "dock"   | jq -r 'if .error then "ERROR: \(.error)" else "Docked." end'; }
cmd_undock() { api "undock" | jq -r 'if .error then "ERROR: \(.error)" else "Undocked." end'; }
cmd_mine()   { api "mine"   | jq -r 'if .error then "ERROR: \(.error)" else .result | "Mined: \(.yield // .item // .resource // "ore") x\(.quantity // .amount // "?")" end'; }
cmd_refuel() { api "refuel" | jq -r 'if .error then "ERROR: \(.error)" else .result | "Refueled. Fuel: \(.fuel // "?")/\(.max_fuel // "?")" end'; }
cmd_repair() { api "repair" | jq -r 'if .error then "ERROR: \(.error)" else .result | "Repaired. Hull: \(.hull // "?")/\(.max_hull // "?")" end'; }

cmd_chat() {
  local channel="${1:?Usage: sm chat <channel> \"message\"}"
  local msg="${2:?Usage: sm chat <channel> \"message\"}"
  api "chat" "$(jq -n --arg c "$channel" --arg m "$msg" '{channel: $c, content: $m}')" | jq -r '
    if .error then "ERROR: \(.error)" else "Sent to \(.result.channel // "?")." end
  '
}

cmd_raw() {
  local endpoint="${1:?Usage: sm raw <endpoint> [json-body]}"
  local body="${2:-"{}"}"
  api "$endpoint" "$body"
}

# --- Dispatch ---

CMD="${1:-help}"
shift 2>/dev/null || true

case "$CMD" in
  login)          cmd_login "$@" ;;
  status)         cmd_status "$@" ;;
  pois)           cmd_pois "$@" ;;
  system)         cmd_system "$@" ;;
  log)            cmd_log "$@" ;;
  cargo)          cmd_cargo "$@" ;;
  sell-all)       cmd_sell_all "$@" ;;
  skills)         cmd_skills "$@" ;;
  nearby)         cmd_nearby "$@" ;;
  notifications)  cmd_notifications "$@" ;;
  travel)         cmd_travel "$@" ;;
  dock)           cmd_dock "$@" ;;
  undock)         cmd_undock "$@" ;;
  mine)           cmd_mine "$@" ;;
  refuel)         cmd_refuel "$@" ;;
  repair)         cmd_repair "$@" ;;
  chat)           cmd_chat "$@" ;;
  raw)            cmd_raw "$@" ;;
  help|--help|-h)
    echo "sm — SpaceMolt CLI (zero-token game actions)"
    echo ""
    echo "Setup:"
    echo "  sm login                  Login (reads ./me/credentials.txt)"
    echo ""
    echo "Info (no rate limit):"
    echo "  sm status                 Credits, location, ship, fuel"
    echo "  sm pois                   POIs in current system"
    echo "  sm system                 System overview + connections"
    echo "  sm log                    Recent captain's log"
    echo "  sm cargo                  Cargo contents"
    echo "  sm skills                 Trained skills"
    echo "  sm nearby                 Nearby players"
    echo "  sm notifications          Pending notifications"
    echo ""
    echo "Actions (1 per 10s tick):"
    echo "  sm log add \"text\"         Add captain's log entry"
    echo "  sm sell-all               Sell all cargo (auto-waits between items)"
    echo "  sm travel <poi-id>        Travel to POI"
    echo "  sm dock / sm undock       Dock or undock"
    echo "  sm mine                   Mine once"
    echo "  sm refuel / sm repair     Refuel or repair"
    echo "  sm chat <ch> \"msg\"        Chat (system/local/faction/private)"
    echo ""
    echo "Advanced:"
    echo "  sm raw <endpoint> [json]  Raw API call"
    ;;
  *)
    die "Unknown command: $CMD (try: sm help)"
    ;;
esac
